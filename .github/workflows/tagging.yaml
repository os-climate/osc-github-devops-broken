---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2024 The Linux Foundation <https://linuxfoundation.org>

name: "🏷️ Repository Tagging"
# Enumerate current tag, generate development/production tags, create initial tag

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      CREATE_MISSING:
        description: "Create an initial tag if none found in repository"
        type: boolean
        required: false
        default: false

    outputs:
      CURRENT_TAG:
        description: "Existing tag from repository"
        value: ${{ jobs.tagging.outputs.current_tag }}
      INVALID_TAG:
        description: "Flags if the current repository tag is NOT semantiv"
        value: ${{ jobs.tagging.outputs.invalid_tag }}
      DEVELOPMENT_TAG:
        description: "Semantic tag for development releases/builds"
        value: ${{ jobs.tagging.outputs.development_tag }}
      PRODUCTION_TAG:
        description: "Semantic tag for production releases/builds"
        value: ${{ jobs.tagging.outputs.production_tag }}
      PRE_RELEASE:
        description: "Set true if test/development release"
        value: ${{ jobs.tagging.outputs.pre_release }}
      BUILD_TAG:
        description: "Semantic tag for this release/build"
        value: ${{ jobs.tagging.outputs.build_tag }}

jobs:
  tagging:
    name: "Gather Tags/Build Data"
    runs-on: ubuntu-latest
    outputs:
      current_tag: ${{ steps.repo-tags.outputs.current_tag }}
      invalid_tag: ${{ steps.repo-tags.outputs.invalid_tag }}
      development_tag: ${{ steps.development-tag.outputs.development_tag }}
      production_tag: ${{ steps.production-tag.outputs.production_tag }}
      pre_release: ${{ steps.this-build.outputs.pre_release }}
      build_tag: ${{ steps.this-build.outputs.build_tag }}

    steps:
      - name: "Retrieve/verify tags"
        id: repo-tags
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-fetch@main

      - name: "Generate tag for DEVELOPMENT builds"
        id: development-tag
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-build@main
        with:
          tag: ${{ steps.repo-tags.outputs.vtag }}

      - name: "Generate tag for PRODUCTION releases"
        id: production-tag
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-increment@main
        with:
          tag: ${{ steps.repo-tags.outputs.vtag }}

      # ToDo
      #  1. Add type based on labels in pull request
      #  2. Add type based on strings in commit message
      - name: "Flag build/release type"
        id: this-build
        shell: bash
        run: |
          # Flag build/release type
          if [ "$GITHUB_REF_NAME" == "main" ] &&
             [ "$GITHUB_REF_TYPE" == "branch" ] &&
             [ "$GITHUB_EVENT_NAME" == "push" ]; then
            echo "pre_release=true" >> "$GITHUB_OUTPUT"
            echo "build_tag=${{ steps.development-tag.outputs.vtag }}" >> "$GITHUB_OUTPUT"
          else
            echo "pre_release=false" >> "$GITHUB_OUTPUT"
            echo "build_tag=${{ steps.production-tag.outputs.vtag }}" >> "$GITHUB_OUTPUT"
          fi

      # Only runs if no tags are found, pushes an initial v0.0.0
      - name: "Create initial v0.0.0 tag"
        id: initial-tag
        if: steps.repo-tags.outputs.invalid == 'true' &&
          inputs.CREATE_MISSING == 'true'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          tag_name: v0.0.0
