---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2024 The Linux Foundation <https://linuxfoundation.org>

name: "ðŸ§ª Test GitHub Actions"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main", "master"]
    paths: [".github/**"]
  pull_request:
    types: [opened, reopened, edited, synchronize]
    paths: [".github/**"]
    branches: ["main", "master"]

env:
  DEFAULT-PYTHON: "3.10"
  ARTEFACTS: "dist"
  # Configures publishing to PyPI
  PUBLISH: "true"

jobs:
  ### Test Individual Composite Actions ###

  one-password-test:
    name: "1Password Access"
    uses: os-climate/osc-github-devops/.github/workflows/one-password-credentials.yaml@main
    #Â Do NOT run until change is merged; secrets will NOT be available and workflow WILL fail
    if: github.event_name != 'pull_request'
    with:
      ELEMENT: "op://67hdehutbpddhfbgm6ffjvdsbu/Test Secure Note/notesPlain"
      EXPORT-ENV: "true"
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_DEVELOPMENT }}

  test:
    name: "Synthetic Tests"
    runs-on: ubuntu-latest
    # if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          # Does not currently work: https://github.com/actions/checkout/issues/1471
          fetch-tags: true
          # The repository-tags-fetch action  currently contains a workaround for this behaviour

      - name: "Action: repository-classify-content"
        id: repository-classify-content
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/repository-content-classify@main

      - name: "Action: python-versions-matrix"
        id: python-versions-matrix
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/python-versions-matrix@main

      - name: "Action: python-twine-check"
        id: python-twine-check
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/python-twine-check@main
        with:
          path: "tests/dist"

      - name: "Action: semantic-tag-validate [semantic tag]"
        id: semantic-tag-validate-good
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-validate@main
        with:
          tag: "v1.2.3"

      - name: "Action: semantic-tag-validate [junk tag]"
        id: semantic-tag-validate-junk
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-validate@main
        with:
          tag: "v1.not-valid.3.garbage"

      - name: "Validate: semantic-tag-validate"
        shell: bash
        run: |
          # Check output from: semantic-tag-validate [semantic/junk]
          ERRORS="false"
          if [ "${{ steps.semantic-tag-validate-good.outputs.valid }}" != "true" ]; then
            echo "Errors with: semantic-tag-validate v1.2.3"
            ERRORS="true"
          fi
          if [ "${{ steps.semantic-tag-validate-junk.outputs.valid }}" != "false" ]; then
            echo "Errors with: semantic-tag-increment v1.not-valid.3.garbage"
            ERRORS="true"
          fi
          if [ "$ERRORS" = "true" ]; then
            echo "ERROR: check semantic tag validation action/code"; exit 1
          else
            echo "All tag validation tests passed, no errors found"
          fi

      - name: "Action: repository-tags-fetch"
        id: repository-tags-fetch
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/repository-tags-fetch@main

      - name: "Action: semantic-tag-increment [patch]"
        id: semantic-tag-increment-patch
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-increment@main
        with:
          tag: "v2.9.6"
          type: "patch"

      - name: "Action: semantic-tag-increment [minor]"
        id: semantic-tag-increment-minor
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-increment@main
        with:
          tag: "v0.1.2"
          type: "minor"

      - name: "Action: semantic-tag-increment [major]"
        id: semantic-tag-increment-major
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/semantic-tag-increment@main
        with:
          tag: "v1.2.3"
          type: "major"

      - name: "Validate Incremented Tags"
        shell: bash
        run: |
          # Check output from: semantic-tag-increment
          ERRORS="false"
          if [ "${{ steps.semantic-tag-increment-patch.outputs.tag }}" != "2.9.7" ]; then
            echo "Errors with: semantic-tag-increment [patch]"
            ERRORS="true"
          fi
          if [ "${{ steps.semantic-tag-increment-minor.outputs.tag }}" != "0.2.0" ]; then
            echo "Errors with: semantic-tag-increment [minor]"
            ERRORS="true"
          fi
          if [ "${{ steps.semantic-tag-increment-major.outputs.tag }}" != "2.0.0" ]; then
            echo "Errors with: semantic-tag-increment [major]"
            ERRORS="true"
          fi
          if [ "$ERRORS" = "true" ]; then
            echo "ERROR: check tag manipulation action/code"; exit 1
          else
            echo "All tag check tests passed, no errors found"
          fi

      - name: "Action: url-validity-check"
        id: url-validity-check
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/url-validity-check@main
        with:
          prefix: "https://test.pypi.org/project"
          string: "/ITR"
          suffix: "/"

      - name: "Action: github-workflow-metadata"
        id: github-workflow-metadata
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/github-workflow-metadata@main

      - name: "Action: github-mandatory-labels"
        id: github-mandatory-labels
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/github-mandatory-labels@main

      - name: "Validate: github-mandatory-labels"
        shell: bash
        run: |
          # Check output from: github-mandatory-labels
          if [ "${{ steps.github-mandatory-labels.outputs.present }}" = "true" ]; then
            echo "Labels are reported present:"
            if (gh label list | grep release); then
              exit 0
            fi
          elif [ "${{ steps.github-mandatory-labels.outputs.created }}" = "true" ]; then
            echo "Labels are reported present:"
            if (gh label list | grep release); then
              exit 0
            fi
          else
            echo "The expected action outputs/labels were NOT found"
            gh label list
            exit 1
          fi

      - name: "Action: github-mandatory-secrets"
        uses: os-climate/osc-github-devops/.github/actions/github-mandatory-secrets@main
        #Â Do NOT run until change is merged; secrets will NOT be available and workflow WILL fail
        if: github.event_name != 'pull_request'
        #Â continue-on-error: true
        with:
          # Mandatory secrets/variables to check
          pypi_development: ${{ secrets.PYPI_DEVELOPMENT }}
          pypi_production: ${{ secrets.PYPI_PRODUCTION }}
          one_password_development: ${{ secrets.ONE_PASSWORD_DEVELOPMENT }}

      - name: "Action: string-comparison [match]"
        id: string-comparison-matching
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/string-comparison@main
        with:
          string_a: "Mary had a little lamb"
          string_b: "Mary had a little lamb"

      - name: "Action: string-comparison [different]"
        id: string-comparison-different
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/string-comparison@main
        with:
          string_a: "Mary had a little lamb"
          string_b: "I don't like eating lamb"

      - name: "Action: string-comparison [sub-string match]"
        id: string-comparison-substring
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/string-comparison@main
        with:
          string_a: "Mary had a little lamb"
          string_b: "a little lamb"
          substring_match: "true"

      - name: "Action: string-comparison [sub-string match, case-insensitive]"
        id: string-comparison-substring-nocase
        # yamllint disable-line rule:line-length
        uses: os-climate/osc-github-devops/.github/actions/string-comparison@main
        with:
          string_a: "Mary had a little lamb"
          string_b: "A little lamb"
          substring_match: "true"
          case_insensitive: "true"

      - name: "Report Errors: string-comparison"
        # yamllint disable-line rule:line-length
        if: steps.string-comparison-matching.outputs.match == 'false'
          || steps.string-comparison-different.outputs.match == 'true'
          || steps.string-comparison-substring.outputs.match == 'false'
          || steps.string-comparison-substring-nocase.outputs.match == 'false'
        shell: bash
        run: |
          # Check string-comparison action logic
          echo "String comparison/action logic appears to be broken"
          exit 1
