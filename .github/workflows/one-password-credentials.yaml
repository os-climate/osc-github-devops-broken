---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2024 The Linux Foundation <https://linuxfoundation.org>

name: "ðŸ§ª Test 1Password Access"
# Builds a project for any number of specified Python versions"

on:
  workflow_call:
    secrets:
      ONE_PASSWORD_DEVELOPMENT:
        description: "1Password service account credential"
        required: true

jobs:
  one-password-access:
    name: "Access test credential"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Load test note from OS-Climate Vault [Development/Testing]"
        uses: 1password/load-secrets-action@v2
        with:
          # Export loaded secrets as environment variables
          export-env: true
          # Parameters below are from: "Test Secure Note"
        env:
          TEST_NOTE_LABEL: "op://67hdehutbpddhfbgm6ffjvdsbu/Test Secure Note/notesPlain"
          TEST_NOTE_SHA: "op://67hdehutbpddhfbgm6ffjvdsbu/Test Secure Note/add more/sha1sum"
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_DEVELOPMENT }}

      - name: "Print masked variables and validate"
        # Prints: Secret: ***
        run: |
          # Print masked variables
          echo "TEST_NOTE_LABEL: $TEST_NOTE_LABEL"
          echo "TEST_NOTE_SHA: $TEST_NOTE_SHA"
          SHA1SUM=$(echo -n "$TEST_NOTE_LABEL" | sha1sum)
          if [[ "$SHA1SUM" == "$TEST_NOTE_SHA" ]]; then
            echo "Success: sha1sum of retrieved element matches expected value"
          else
            echo "Error: sha1sum of retrieved element did NOT match expected value"; exit 1
          fi
